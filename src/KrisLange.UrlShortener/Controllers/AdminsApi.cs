/*
 * Link Shortening Service
 *
 * This is an API for a Link Shortening Service
 *
 * OpenAPI spec version: 1.0.0
 * Contact: kris@krislange.com
 * Generated by: https://github.com/swagger-api/swagger-codegen.git
 */

using System;
using System.Collections.Generic;
using Microsoft.AspNetCore.Mvc;
using Microsoft.Identity.Web;
using Swashbuckle.AspNetCore.Annotations;
using Swashbuckle.AspNetCore.SwaggerGen;
using Newtonsoft.Json;
using System.ComponentModel.DataAnnotations;
using System.Formats.Asn1;
using KrisLange.UrlShortener.Attributes;
using Microsoft.AspNetCore.Authorization;
using KrisLange.UrlShortener.Models;
using KrisLange.UrlShortener.Models.DomainModels;
using KrisLange.UrlShortener.Store;
using Microsoft.AspNetCore.Authentication.JwtBearer;
using Microsoft.Extensions.Logging;
using Microsoft.Identity.Web.Resource;
using Microsoft.OpenApi.Writers;
using Serilog;

namespace KrisLange.UrlShortener.Controllers
{
    /// <summary>
    /// 
    /// </summary>
    [Authorize(AuthenticationSchemes = JwtBearerDefaults.AuthenticationScheme)]
    [ApiController]
    public class AdminsApiController : ControllerBase
    {
        private readonly ILogger<AdminsApiController> _logger;
        private readonly IKeyValueStore _kvStore;
        public AdminsApiController(ILogger<AdminsApiController> logger, IKeyValueStore kvStore)
        {
            _logger = logger;
            _kvStore = kvStore;
        }

        /// <summary>
        /// adds a link with the specified shortUrlId
        /// </summary>
        /// <remarks>Post a URL to be shortened </remarks>
        /// <param name="postUrlSpec">The URL which needs to be shortened</param>
        /// <response code="200">A new shortURL was created!</response>
        [HttpPut]
        [Route("/lnk")]
        [ValidateModelState]
        [SwaggerOperation("PostUrl")]
        [SwaggerResponse(200, type: typeof(UrlObject), description: "A new shortURL was created!")]
        public virtual IActionResult PostUrl([FromBody]NewUrlSpec postUrlSpec)
        {
            string shortUrlId = Math.Abs(postUrlSpec.GetHashCode()).ToString().Substring(0, 4);
            
            var url = new UrlModel() {ShortUrlId = shortUrlId, LongUrl = postUrlSpec.LongUrl};
            _logger.LogInformation("PutUrl: {@url}", url);

            _kvStore.Put(url);

            UrlObject result = UrlObject.Convert(url);
            
            return this.Ok(result);
        }

        /// <summary>
        /// adds a link with the specified shortUrlId
        /// </summary>
        /// <remarks>Put a URL who&#39;s shortcut is shortUrlId </remarks>
        /// <param name="shortUrlId">the shortUrl ID</param>
        /// <param name="newUrlSpec">The URL which needs to be shortened</param>
        /// <response code="201">A new shortUrl was created!</response>
        [HttpPut]
        [Route("/lnk/{shortUrlId}")]
        [ValidateModelState]
        [SwaggerOperation("PutUrl")]
        [SwaggerResponse(statusCode: 201, type: typeof(UrlObject), description: "A new shortUrl was created!")]
        public virtual IActionResult PutUrl([FromRoute][Required]string shortUrlId, [FromBody]NewUrlSpec newUrlSpec)
        {
            var url = new UrlModel() {ShortUrlId = shortUrlId, LongUrl = newUrlSpec.LongUrl}; 
            _logger.LogInformation("PostUrl: {@url}", url);

            _kvStore.Put(url);

            UrlObject result = UrlObject.Convert(url);
            
            return this.Created(shortUrlId, result);
        }
    }
}
